<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador portada 474x250</title>

  <link rel="stylesheet" href="./styles.css">

  <!-- PDF.js local -->
  <script src="./lib/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "./lib/pdf.worker.min.js";
    }
  </script>

  <style>
    .container {
      max-width: 1100px;
      margin: 40px auto;
      display: grid;
      gap: 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    canvas {
      width: 100%;
      max-width: 474px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .panel {
      display: grid;
      gap: 16px;
    }

    .control {
      display: grid;
      gap: 6px;
    }

    input[type="range"] {
      width: 100%;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .primary {
      background: #111;
      color: #fff;
    }

    .secondary {
      background: #eee;
    }

    .muted {
      font-size: 13px;
      opacity: .7;
    }
  </style>
</head>
<body>

<div class="container">

  <h1>Generador 474Ã—250</h1>

  <div class="grid">

    <div class="panel">

      <div class="control">
        <label>Archivo (PDF / JPG / PNG)</label>
        <input type="file" id="fileInput" accept=".pdf,image/*">
      </div>

      <div class="control">
        <label>Alto franja superior (%)</label>
        <input type="range" id="cropPct" min="10" max="60" value="30">
        <div class="muted">Valor: <span id="cropVal">30</span>%</div>
      </div>

      <div class="control">
        <label>Opacidad fondo</label>
        <input type="range" id="bgAlpha" min="0" max="30" value="10">
        <div class="muted">Valor: <span id="alphaVal">0.10</span></div>
      </div>

      <div class="control">
        <label>Margen (px)</label>
        <input type="range" id="marginPx" min="0" max="40" value="10">
        <div class="muted">Valor: <span id="marginVal">10</span> px</div>
      </div>

      <div style="display:flex;gap:12px;">
        <button class="primary" id="downloadBtn" disabled>Descargar JPG</button>
        <button class="secondary" id="resetBtn">Reset</button>
      </div>

    </div>

    <div>
      <canvas id="outCanvas" width="474" height="250"></canvas>
    </div>

  </div>
</div>

<script>
const OUT_W = 474;
const OUT_H = 250;

const canvas = document.getElementById("outCanvas");
const ctx = canvas.getContext("2d");

const fileInput = document.getElementById("fileInput");
const cropPct = document.getElementById("cropPct");
const bgAlpha = document.getElementById("bgAlpha");
const marginPx = document.getElementById("marginPx");

const cropVal = document.getElementById("cropVal");
const alphaVal = document.getElementById("alphaVal");
const marginVal = document.getElementById("marginVal");

const downloadBtn = document.getElementById("downloadBtn");
const resetBtn = document.getElementById("resetBtn");

let sourceCanvas = null;

cropPct.oninput = () => { cropVal.textContent = cropPct.value; if(sourceCanvas) render(); };
bgAlpha.oninput = () => { alphaVal.textContent = (bgAlpha.value/100).toFixed(2); if(sourceCanvas) render(); };
marginPx.oninput = () => { marginVal.textContent = marginPx.value; if(sourceCanvas) render(); };

fileInput.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  if (file.type === "application/pdf" || file.name.endsWith(".pdf")) {
    sourceCanvas = await rasterizePDF(file);
  } else {
    sourceCanvas = await rasterizeImage(file);
  }

  render();
  downloadBtn.disabled = false;
});

async function rasterizeImage(file){
  return new Promise(resolve=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement("canvas");
      c.width = img.width;
      c.height = img.height;
      c.getContext("2d").drawImage(img,0,0);
      resolve(c);
    };
    img.src = URL.createObjectURL(file);
  });
}

async function rasterizePDF(file){
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buffer}).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({scale:2});
  const c = document.createElement("canvas");
  c.width = viewport.width;
  c.height = viewport.height;
  await page.render({canvasContext:c.getContext("2d"),viewport}).promise;
  return c;
}

function render(){
  ctx.clearRect(0,0,OUT_W,OUT_H);

  const cropPercent = cropPct.value/100;
  const alpha = bgAlpha.value/100;
  const margin = parseInt(marginPx.value);

  // BACKGROUND (cover al ancho completo)
  const stripH = sourceCanvas.height * cropPercent;
  const scaleBg = Math.max(OUT_W/sourceCanvas.width, OUT_H/stripH);

  const bgW = sourceCanvas.width * scaleBg;
  const bgH = stripH * scaleBg;

  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.drawImage(
    sourceCanvas,
    0,0,sourceCanvas.width,stripH,
    (OUT_W-bgW)/2,
    (OUT_H-bgH)/2,
    bgW,bgH
  );
  ctx.restore();

  // FOREGROUND (encaja por ALTO completo)
  const availableH = OUT_H - margin*2;
  const scaleFg = availableH / sourceCanvas.height;

  const fgW = sourceCanvas.width * scaleFg;
  const fgH = sourceCanvas.height * scaleFg;

  const fgX = (OUT_W - fgW)/2;
  const fgY = margin;

  ctx.drawImage(sourceCanvas, fgX, fgY, fgW, fgH);
}

downloadBtn.addEventListener("click",()=>{
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/jpeg",0.92);
  link.download = "portada_474x250.jpg";
  link.click();
});

resetBtn.onclick = ()=>{
  sourceCanvas = null;
  ctx.clearRect(0,0,OUT_W,OUT_H);
  fileInput.value="";
  downloadBtn.disabled = true;
};
</script>

</body>
</html>