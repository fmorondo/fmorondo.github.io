<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador portada del periódico para Twitter/X</title>

  <link rel="stylesheet" href="./styles.css">

  <!-- PDF.js local -->
  <script src="./lib/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "./lib/pdf.worker.min.js";
    }
  </script>

  <style>
    /* Ajustes mínimos (por encima de styles.css) */
    .container { max-width: 1100px; margin: 40px auto; display: grid; gap: 24px; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: start; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .panel { display: grid; gap: 16px; }
    .control { display: grid; gap: 6px; }
    .muted { font-size: 13px; opacity: .7; }
    canvas { width: 100%; max-width: 474px; border-radius: 12px; border: 1px solid #ddd; background: #fff; }
    button { padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .primary { background: #111; color: #fff; }
    .secondary { background: #eee; }
  </style>
</head>

<body>
<div class="container">
  <h1>Portada del periódico para Twitter/X</h1>

  <div class="grid">
    <div class="panel">
      <div class="control">
        <label>Archivo (PDF / JPG / PNG)</label>
        <input type="file" id="fileInput" accept=".pdf,image/*">
      </div>

      <div class="control">
        <label>Alto franja superior (%)</label>
        <input type="range" id="cropPct" min="20" max="60" value="38">
        <div class="muted">Valor: <span id="cropVal">38</span>%</div>
      </div>

      <div class="control">
        <label>Opacidad fondo</label>
        <input type="range" id="bgAlpha" min="0" max="30" value="10">
        <div class="muted">Valor: <span id="alphaVal">0.10</span></div>
      </div>

      <div class="control">
        <label>Margen (px)</label>
        <input type="range" id="marginPx" min="0" max="40" value="10">
        <div class="muted">Valor: <span id="marginVal">10</span> px</div>
      </div>

      <div class="control">
        <label>Calidad JPG</label>
        <input type="range" id="jpgQuality" min="70" max="100" value="92">
        <div class="muted">Valor: <span id="jpgVal">0.92</span></div>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="primary" id="actionBtn" disabled>Copiar texto + descargar JPG</button>
        <button class="secondary" id="resetBtn" type="button">Reset</button>
      </div>

      <div class="muted" id="status">Sube un archivo para empezar.</div>
    </div>

    <div>
  <canvas id="outCanvas" width="474" height="250"></canvas>

  <div style="margin-top:12px;">
    <div style="border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;">
      <pre id="messageText" style="margin:0;white-space:pre-wrap;"></pre>
    </div>
  </div>
</div>
</div>
  </div>
</div>

<script>
const OUT_W = 474;
const OUT_H = 250;

const canvas = document.getElementById("outCanvas");
const ctx = canvas.getContext("2d");

const fileInput = document.getElementById("fileInput");
const cropPct = document.getElementById("cropPct");
const bgAlpha = document.getElementById("bgAlpha");
const marginPx = document.getElementById("marginPx");
const jpgQuality = document.getElementById("jpgQuality");

const cropVal = document.getElementById("cropVal");
const alphaVal = document.getElementById("alphaVal");
const marginVal = document.getElementById("marginVal");
const jpgVal = document.getElementById("jpgVal");

const actionBtn = document.getElementById("actionBtn");
const resetBtn = document.getElementById("resetBtn");
const statusEl = document.getElementById("status");

const messageTextEl = document.getElementById("messageText");
const FIXED_URL = "https://www.diariodenavarra.es/pags/portada-dia.html";

function getTodayPartsMadrid() {
  const parts = new Intl.DateTimeFormat("es-ES", {
    timeZone: "Europe/Madrid",
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  }).formatToParts(new Date());

  const get = (type) => parts.find(p => p.type === type)?.value;
  return {
    weekday: get("weekday"),
    day: get("day"),
    month: get("month"),
    year: get("year"),
  };
}

function buildMessageText() {
  const { weekday, day, month, year } = getTodayPartsMadrid();
  return `Buenos días, te dejamos la portada de Diario de Navarra de este ${weekday}, ${day} de ${month} de ${year}.\n${FIXED_URL}`;
}

function updateMessageBox() {
  messageTextEl.textContent = buildMessageText();
}

// Inicializa al cargar
updateMessageBox();

let sourceCanvas = null;

function setSmoothing(c) {
  const cctx = c.getContext("2d");
  cctx.imageSmoothingEnabled = true;
  cctx.imageSmoothingQuality = "high";
}

setSmoothing(canvas);

cropPct.oninput = () => { cropVal.textContent = cropPct.value; if(sourceCanvas) render(); };
bgAlpha.oninput = () => { alphaVal.textContent = (bgAlpha.value/100).toFixed(2); if(sourceCanvas) render(); };
marginPx.oninput = () => { marginVal.textContent = marginPx.value; if(sourceCanvas) render(); };
jpgQuality.oninput = () => { jpgVal.textContent = (jpgQuality.value/100).toFixed(2); };

fileInput.addEventListener("change", async e => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    statusEl.textContent = "Procesando…";
    actionBtn.disabled = true;

    if (file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf")) {
      if (!window.pdfjsLib) throw new Error("PDF.js no está cargado. Revisa /lib/pdf.min.js");
      sourceCanvas = await rasterizePDF(file);
    } else {
      sourceCanvas = await rasterizeImage(file);
    }

    render();
    actionBtn.disabled = false;
    statusEl.textContent = "Listo.";
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error: " + (err?.message || String(err));
    sourceCanvas = null;
    actionBtn.disabled = true;
    ctx.clearRect(0, 0, OUT_W, OUT_H);
  }
});

async function rasterizeImage(file){
  const img = await fileToImage(file);
  const c = document.createElement("canvas");
  c.width = img.naturalWidth || img.width;
  c.height = img.naturalHeight || img.height;
  setSmoothing(c);
  c.getContext("2d").drawImage(img, 0, 0);
  return c;
}

function fileToImage(file) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("No se pudo leer la imagen.")); };
    img.src = url;
  });
}

async function rasterizePDF(file){
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const page = await pdf.getPage(1);

  // Más calidad: escala alta, pero limitamos tamaño final para no romper memoria
  const SCALE = 4.0;
  let viewport = page.getViewport({ scale: SCALE });

  const MAX_DIM = 6000; // seguridad
  if (Math.max(viewport.width, viewport.height) > MAX_DIM) {
    const shrink = MAX_DIM / Math.max(viewport.width, viewport.height);
    viewport = page.getViewport({ scale: SCALE * shrink });
  }

  const c = document.createElement("canvas");
  c.width = Math.floor(viewport.width);
  c.height = Math.floor(viewport.height);
  setSmoothing(c);

  await page.render({ canvasContext: c.getContext("2d"), viewport }).promise;
  return c;
}

function render(){
  const src = sourceCanvas;
  if (!src) return;

  const cropPercent = Number(cropPct.value) / 100;
  const alpha = Number(bgAlpha.value) / 100;
  const margin = parseInt(marginPx.value, 10);

  // IMPORTANTÍSIMO para JPG: fondo blanco (evita “negro” al aplanar transparencia)
  ctx.save();
  ctx.globalAlpha = 1.0;
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, OUT_W, OUT_H);
  ctx.restore();

  // BACKGROUND: franja superior (desde y=0), escalada "cover" a 474x250
  const stripH = Math.max(1, Math.floor(src.height * cropPercent));
  const scaleBg = Math.max(OUT_W / src.width, OUT_H / stripH);

  const bgW = src.width * scaleBg;
  const bgH = stripH * scaleBg;

  // Anclar arriba (no centrar vertical): mantiene “mancheta + titulares”
  const bgX = (OUT_W - bgW) / 2;
  const bgY = 0;

  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.drawImage(
    src,
    0, 0, src.width, stripH,
    bgX, bgY, bgW, bgH
  );
  ctx.restore();

  // FOREGROUND: encajar por ALTO completo (sin padding vertical)
const scaleFg = OUT_H / src.height;

const fgW = src.width * scaleFg;
const fgH = src.height * scaleFg; // será exactamente 250

const fgX = (OUT_W - fgW) / 2;
const fgY = 0; // pegado arriba

ctx.save();
ctx.globalAlpha = 1.0;
ctx.drawImage(src, fgX, fgY, fgW, fgH);
ctx.restore();
}

actionBtn.addEventListener("click", async () => {
  // 1) Copiar texto (mensaje + URL)
  const textToCopy = buildMessageText();
  try {
    await navigator.clipboard.writeText(textToCopy);
  } catch {
    // Fallback si clipboard falla
    const ta = document.createElement("textarea");
    ta.value = textToCopy;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
  }

  // 2) Descargar JPG
  const q = Number(jpgQuality?.value ?? 92) / 100; // si mantienes el slider
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/jpeg", q);
  link.download = "portada_474x250.jpg";
  link.click();
});

resetBtn.onclick = ()=>{
  sourceCanvas = null;
  ctx.clearRect(0,0,OUT_W,OUT_H);
  fileInput.value = "";
  actionBtn.disabled = true;
  statusEl.textContent = "Sube un archivo para empezar.";
  updateMessageBox();
};
</script>
</body>
</html>