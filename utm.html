<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de URLs UTM con is.gd</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="brand">ðŸ”— Generador de URLs UTM</div>
  </header>

  <main>
    <div class="card stack">
      <h1 class="title">Crear enlaces UTM</h1>

      <label>Introduce las URLs (una por lÃ­nea):</label>
      <textarea id="urls" rows="5"></textarea>

      <label>SecciÃ³n:</label>
      <input type="text" id="section">

      <button id="btn-generar">Generar URLs</button>
    </div>

    <div class="card stack" id="result"></div>
  </main>

  <script>
    // === FunciÃ³n de acortamiento usando JSONP ===
    function acortar(url) {
      return new Promise((resolve) => {
        const encoded = encodeURIComponent(url);
        const callbackName = "jsonp_" + Math.random().toString(36).substring(2);
        const script = document.createElement("script");

        window[callbackName] = (data) => {
          delete window[callbackName];
          script.remove();
          if (data && data.shorturl) {
            resolve(data.shorturl);
          } else {
            resolve(url);
          }
        };

        script.src = `https://is.gd/create.php?format=json&callback=${callbackName}&url=${encoded}`;
        document.body.appendChild(script);
      });
    }

    // === Generar las URLs con parÃ¡metros UTM ===
    function generar() {
      const urls = document.getElementById("urls").value.trim().split("\n").filter(u => u !== "");
      const section = document.getElementById("section").value.trim();
      const result = document.getElementById("result");
      result.innerHTML = "";

      if (urls.length === 0 || !section) {
        alert("Introduce al menos una URL y una secciÃ³n.");
        return;
      }

      urls.forEach((url, i) => {
        const story = `${url}?utm_source=instagram&utm_medium=social&utm_campaign=${encodeURIComponent(section)}&utm_content=story`;
        const post  = `${url}?utm_source=later&utm_medium=linkinbio&utm_campaign=${encodeURIComponent(section)}&utm_content=post`;
        const whatsapp = `${url}?utm_source=Whatsapp&utm_medium=enlace&utm_campaign=${encodeURIComponent(section)}&utm_id=alerta_comunidad`;
        const linkedin = `${url}?utm_source=linkedIn&utm_medium=enlace&utm_campaign=${encodeURIComponent(section)}&utm_id=post`;
        
        result.appendChild(crearCaja(`story-${i}`, "Story de Instagram", story));
        result.appendChild(crearCaja(`post-${i}`, "Post de Instagram", post));
        result.appendChild(crearCaja(`whatsapp-${i}`, "WhatsApp", whatsapp));
        result.appendChild(crearCaja(`linkedin-${i}`, "linkedIn", linkedin));

      });
    }

    // === Crear la caja de resultado ===
    function crearCaja(id, titulo, url) {
      const cont = document.createElement("div");
      cont.className = "stack";

      const h3 = document.createElement("h3");
      h3.textContent = titulo;
      cont.appendChild(h3);

      const div = document.createElement("div");
      div.className = "result";
      div.id = id;
      div.textContent = url;
      cont.appendChild(div);

      const row = document.createElement("div");
      row.className = "row";

      const btnCopiar = document.createElement("button");
      btnCopiar.textContent = "Copiar";
      btnCopiar.onclick = () => copiar(id);
      row.appendChild(btnCopiar);

      const btnAcortar = document.createElement("button");
      btnAcortar.textContent = "Acortar";
      btnAcortar.onclick = () => acortarCaja(id);
      row.appendChild(btnAcortar);

      cont.appendChild(row);
      return cont;
    }

    // === Copiar el contenido visible ===
    function copiar(id) {
      const text = document.getElementById(id).innerText;
      navigator.clipboard.writeText(text).then(() => alert("Copiado âœ…"));
    }

    // === Acortar la URL visible ===
    async function acortarCaja(id) {
      const caja = document.getElementById(id);
      const urlOriginal = caja.innerText;
      const urlCorta = await acortar(urlOriginal);
      caja.innerText = urlCorta;

      const contenedor = caja.parentElement;
      if (!contenedor.querySelector(`#copiar-corto-${id}`)) {
        const btn = document.createElement("button");
        btn.id = `copiar-corto-${id}`;
        btn.textContent = "Copiar (corta)";
        btn.onclick = () => copiar(id);
        contenedor.querySelector(".row").appendChild(btn);
      }
    }

    // === Inicializar evento principal ===
    document.getElementById("btn-generar").addEventListener("click", generar);
  </script>
</body>
</html>
